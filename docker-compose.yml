version: '3.8'

services:
  # FX3110 Monitoring Service
  fx3110-monitor:
    build: .
    container_name: fx3110-monitor
    restart: unless-stopped
    network_mode: host  # Use host networking to access eth0 interface directly
    user: "1000:1000"  # Run as host user to write to logs
    volumes:
      - ./logs:/logs
      - ./config.yaml:/app/config.yaml:ro
      - /etc/localtime:/etc/localtime:ro  # Sync container time with host
      # - /home/pi/.ssh:/root/.ssh:ro  # RUTM50 SSH key (adjust host path)
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1  # Ensure logs are written immediately
    command: sh -c "python monitor.py | tee /logs/fx3110_log.tsv"
    cap_add:
      - NET_RAW  # Required for ping
      - NET_ADMIN  # Required for network interface binding

  # Data API service with dashboard
  fx3110-api:
    build: ./api
    container_name: fx3110-api
    restart: unless-stopped
    ports:
      - "8080:8080"  # Expose API/dashboard on all interfaces
    volumes:
      - ./logs:/logs:ro  # Read-only access to monitor logs
      - ./config.yaml:/app/config.yaml:ro
      - ./config.py:/app/config.py:ro
      - ./collectors:/app/collectors:ro
    env_file:
      - .env
    depends_on:
      - fx3110-monitor

  # Future: Time-series database (optional)
  # influxdb:
  #   image: influxdb:2.7-alpine
  #   container_name: fx3110-influxdb
  #   restart: unless-stopped
  #   ports:
  #     - "8086:8086"
  #   volumes:
  #     - influxdb-data:/var/lib/influxdb2
  #   environment:
  #     - DOCKER_INFLUXDB_INIT_MODE=setup
  #     - DOCKER_INFLUXDB_INIT_USERNAME=admin
  #     - DOCKER_INFLUXDB_INIT_PASSWORD=changeme123
  #     - DOCKER_INFLUXDB_INIT_ORG=fx3110
  #     - DOCKER_INFLUXDB_INIT_BUCKET=monitoring

  # Future: Visualization dashboard (optional)
  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: fx3110-grafana
  #   restart: unless-stopped
  #   ports:
  #     - "3000:3000"
  #   volumes:
  #     - grafana-data:/var/lib/grafana
  #   depends_on:
  #     - influxdb

volumes:
  influxdb-data:
  grafana-data:
